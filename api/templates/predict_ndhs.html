{% extends "base.html" %}
{% block content %}
<!-- Breadcrumb -->
<nav class="breadcrumb" aria-label="Breadcrumb">
  <a href="/">Home</a> › Predictions › NDHS
</nav>

<h1>National Prediction (NDHS)</h1>
<p>Select a state and indicator below to run a national‑level prediction.</p>

<!-- NDHS Prediction Form -->
<form id="ndhsForm" class="filters">
  <!-- State Selection -->
  <div class="state-select">
    <label for="state">Choose State:</label>
    <select id="state" name="state" required>
      <option value="">-- Select a state --</option>
      <option value="Abia">Abia</option>
      <option value="Adamawa">Adamawa</option>
      <option value="Akwa Ibom">Akwa Ibom</option>
      <option value="Anambra">Anambra</option>
      <option value="Bauchi">Bauchi</option>
      <option value="Bayelsa">Bayelsa</option>
      <option value="Benue">Benue</option>
      <option value="Borno">Borno</option>
      <option value="Cross River">Cross River</option>
      <option value="Delta">Delta</option>
      <option value="Ebonyi">Ebonyi</option>
      <option value="Edo">Edo</option>
      <option value="Ekiti">Ekiti</option>
      <option value="Enugu">Enugu</option>
      <option value="FCT">FCT</option>
      <option value="Gombe">Gombe</option>
      <option value="Imo">Imo</option>
      <option value="Jigawa">Jigawa</option>
      <option value="Kaduna">Kaduna</option>
      <option value="Kano">Kano</option>
      <option value="Katsina">Katsina</option>
      <option value="Kebbi">Kebbi</option>
      <option value="Kogi">Kogi</option>
      <option value="Kwara">Kwara</option>
      <option value="Lagos">Lagos</option>
      <option value="Nasarawa">Nasarawa</option>
      <option value="Niger">Niger</option>
      <option value="Ogun">Ogun</option>
      <option value="Ondo">Ondo</option>
      <option value="Osun">Osun</option>
      <option value="Oyo">Oyo</option>
      <option value="Plateau">Plateau</option>
      <option value="Rivers">Rivers</option>
      <option value="Sokoto">Sokoto</option>
      <option value="Taraba">Taraba</option>
      <option value="Yobe">Yobe</option>
      <option value="Zamfara">Zamfara</option>
    </select>
  </div>

  <!-- Indicator Selection -->
  <div class="indicator-select">
    <label for="indicator">Choose Indicator:</label>
    <select id="indicator" name="indicator" required>
      <option value="">-- Select an indicator --</option>
      <option value="unsafe_water_households">Unsafe water households (%)</option>
      <option value="child_mortality_rate">Child mortality rate</option>
      <option value="maternal_mortality_rate">Maternal mortality rate</option>
      <option value="malnutrition_prevalence">Malnutrition prevalence</option>
      <option value="immunization_coverage">Immunization coverage</option>
      <option value="sanitation_access">Access to sanitation (%)</option>
      <option value="literacy_rate">Literacy rate</option>
      <option value="poverty_index">Poverty index</option>
    </select>
  </div>

  <!-- Value Input -->
  <div class="value-input">
    <label for="value">Enter Value:</label>
    <input type="number" id="value" name="value" step="0.01" required />
  </div>

  <button type="submit" class="btn primary">Run NDHS Prediction</button>
</form>

<!-- Prediction Result -->
<div id="predictionResult" style="margin-top:1.5rem;"></div>

<script>
document.getElementById("ndhsForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const state = document.getElementById("state").value;
  const indicator = document.getElementById("indicator").value;
  const value = document.getElementById("value").value;

  try {
    const res = await fetch("/predict/ndhs", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ state, indicator, value })
    });

    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      const msg = errData.detail || "NDHS prediction failed.";
      alert("❌ " + msg);
      return;
    }

    const result = await res.json();

    // Pop-up alert with risk score
    alert("Prediction complete! Risk Score: " + result.record.risk_score +
          " | Risky: " + (result.record.is_risky ? "Yes" : "No"));

    // Show result inline
    document.getElementById("predictionResult").innerHTML =
      `<p><strong>Prediction Result for ${state}:</strong> ${result.prediction}</p>`;

    // Update dashboard table if present
    const table = document.querySelector(".risk-table tbody");
    if (table && result.record) {
      const r = result.record;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${r.date}</td>
        <td>${r.state}</td>
        <td>${r.indicator}</td>
        <td>${r.value}</td>
        <td>${r.category}</td>
        <td>${r.is_risky ? "Yes" : "No"}</td>
        <td>${r.risk_score}</td>
        <td>${r.source}</td>
      `;
      table.prepend(row);
    }

    //  Reset form after successful submission
    e.target.reset();

  } catch (err) {
    console.error("NDHS prediction error:", err);
    alert(" Network error while running NDHS prediction.");
  }
});
</script>
{% endblock %}
