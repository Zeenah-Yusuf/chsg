{% extends "base.html" %}
{% block content %}
<h1>Local Prediction </h1>
<p>Provide household and location details to run a combined local prediction.</p>

<form id="combinedForm" class="filters">
  <label>Household Water Source</label>
  <input type="text" name="Household_Water_Source" placeholder="Borehole, River, Tap" required>

  <label>Latitude</label>
  <input type="text" id="latInput" name="Location_of_households_Latitude" placeholder="Auto-detected">

  <label>Longitude</label>
  <input type="text" id="lonInput" name="Location_of_households_Longitude" placeholder="Auto-detected">

  <label>Unsafe Water</label>
  <select name="UnsafeWater">
    <option value="0">No</option>
    <option value="1">Yes</option>
  </select>

  <button type="submit">Run Prediction</button>
</form>

<script>
//  Autofill lat/lon using browser geolocation
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    pos => {
      document.getElementById("latInput").value = pos.coords.latitude.toFixed(5);
      document.getElementById("lonInput").value = pos.coords.longitude.toFixed(5);
    },
    err => {
      console.warn("Geolocation failed:", err.message);
    }
  );
}

document.getElementById("combinedForm").addEventListener("submit", async e => {
  e.preventDefault();
  const formData = new FormData(e.target);

  try {
    const res = await fetch("/predict/combined/run", {
      method: "POST",
      body: formData
    });

    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      const msg = errData.detail || "Combined prediction failed.";
      alert("‚ùå " + msg);
      return;
    }

    const result = await res.json();

    //  Pop-up alert with risk score
    alert("Prediction complete! Risk Score: " + result.record.risk_score +
          " | Risky: " + (result.record.is_risky ? "Yes" : "No"));

    //  Update dashboard table if present
    const table = document.querySelector(".risk-table tbody");
    if (table && result.record) {
      const r = result.record;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${r.date}</td>
        <td>${r.lat}</td>
        <td>${r.lon}</td>
        <td>${r.category}</td>
        <td>${r.is_risky ? "Yes" : "No"}</td>
        <td>${r.risk_score}</td>
        <td>${r.source}</td>
      `;
      table.prepend(row);
    }

    //  Reset form after successful submission
    e.target.reset();

  } catch (err) {
    console.error("Combined prediction error:", err);
    alert(" Network error while submitting combined prediction.");
  }
});
</script>
{% endblock %}
