{% extends "base.html" %}
{% block content %}
<h1>Voice Reports</h1>
<p>Select your language, click start, and speak your report. The system will transcribe and send it for prediction.</p>

<div class="voice-controls">
  <label for="langSelect">Recognition Language:</label>
  <select id="langSelect">
    <option value="en-NG">English (Nigeria)</option>
    <option value="yo-NG">Yoruba</option>
    <option value="ig-NG">Igbo</option>
    <option value="ha-NG">Hausa</option>
  </select>
</div>

<div class="voice-controls">
  <button id="startBtn">üé§ Start Recording</button>
  <button id="stopBtn" disabled>‚èπ Stop Recording</button>
</div>

<div class="transcript-box">
  <h3>Transcript:</h3>
  <textarea id="transcript" rows="5" cols="60" readonly></textarea>
</div>

<!-- Optional lat/lon inputs for geotagging -->
<div class="geo-inputs">
  <label>Latitude</label>
  <input type="text" id="latInput" name="lat" placeholder="Auto-detected">

  <label>Longitude</label>
  <input type="text" id="lonInput" name="lon" placeholder="Auto-detected">
</div>

<button id="submitBtn" disabled>Submit Report</button>

<script>
let recognition;
let transcriptText = "";

//  Auto-fill lat/lon using browser geolocation
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    pos => {
      document.getElementById("latInput").value = pos.coords.latitude.toFixed(5);
      document.getElementById("lonInput").value = pos.coords.longitude.toFixed(5);
    },
    err => {
      console.warn("Geolocation failed:", err.message);
    }
  );
}

// Initialize recognition
function initRecognition(lang) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = lang;

  recognition.onresult = (event) => {
    transcriptText = "";
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      transcriptText += event.results[i][0].transcript;
    }
    document.getElementById("transcript").value = transcriptText;
    document.getElementById("submitBtn").disabled = transcriptText.trim().length === 0;
  };

  recognition.onerror = (event) => {
    console.error("Speech recognition error:", event.error);
    alert("‚ùå Voice recognition error: " + event.error);
  };
}

// Start recording
document.getElementById("startBtn").addEventListener("click", () => {
  const lang = document.getElementById("langSelect").value;
  initRecognition(lang);
  recognition.start();
  alert("üé§ Recording started (" + lang + "). Speak now...");
  document.getElementById("startBtn").disabled = true;
  document.getElementById("stopBtn").disabled = false;
});

// Stop recording
document.getElementById("stopBtn").addEventListener("click", () => {
  if (recognition) {
    recognition.stop();
    alert("‚èπ Recording stopped.");
    document.getElementById("startBtn").disabled = false;
    document.getElementById("stopBtn").disabled = true;
  }
});

// Submit transcript
document.getElementById("submitBtn").addEventListener("click", async () => {
  const payload = {
    text: transcriptText,
    lat: document.getElementById("latInput")?.value || 0.0,
    lon: document.getElementById("lonInput")?.value || 0.0,
    source: "voice"
  };

  try {
    const res = await fetch("/ingest/voice", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      const msg = errData.detail || "Voice ingestion failed.";
      alert("‚ùå " + msg);
      return;
    }

    const result = await res.json();

    //  Pop-up alert with risk score
    alert("Prediction complete! Risk Score: " + result.record.risk_score +
          " | Risky: " + (result.record.is_risky ? "Yes" : "No"));

    //  Update dashboard table if present
    const table = document.querySelector(".risk-table tbody");
    if (table && result.record) {
      const r = result.record;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${r.date}</td>
        <td>${r.lat}</td>
        <td>${r.lon}</td>
        <td>${r.category}</td>
        <td>${r.is_risky ? "Yes" : "No"}</td>
        <td>${r.risk_score}</td>
        <td>${r.source}</td>
      `;
      table.prepend(row);
    }

    //  Reset transcript after successful submission
    document.getElementById("transcript").value = "";
    transcriptText = "";
    document.getElementById("submitBtn").disabled = true;

  } catch (err) {
    console.error("Voice upload error:", err);
    alert("‚ö†Ô∏è Network error while submitting voice report.");
  }
});
</script>
{% endblock %}
