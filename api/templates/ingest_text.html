{% extends "base.html" %}
{% block content %}
<h1>Text Reports</h1>
<p>Submit a text report to generate a risk prediction.</p>

<form id="textForm" class="filters">
  <label>Report text</label>
  <input type="text" name="text" placeholder="Cholera outbreak near river" required>

  <label>Latitude</label>
  <input type="text" id="latInput" name="lat" placeholder="Auto-detected">

  <label>Longitude</label>
  <input type="text" id="lonInput" name="lon" placeholder="Auto-detected">

  <button type="submit">Submit</button>
</form>

<script>
//  Auto-fill lat/lon using browser geolocation
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    pos => {
      document.getElementById("latInput").value = pos.coords.latitude.toFixed(5);
      document.getElementById("lonInput").value = pos.coords.longitude.toFixed(5);
    },
    err => {
      console.warn("Geolocation failed:", err.message);
    }
  );
}

document.getElementById("textForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const payload = Object.fromEntries(formData.entries());

  try {
    const response = await fetch("/ingest/text", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const errData = await response.json().catch(() => ({}));
      const msg = errData.detail || "Text ingestion failed.";
      alert("‚ùå " + msg);
      return;
    }

    const result = await response.json();

    //  Pop-up alert with risk score
    alert("Prediction complete! Risk Score: " + result.record.risk_score +
          " | Risky: " + (result.record.is_risky ? "Yes" : "No"));

    //  Update dashboard table if present
    const table = document.querySelector(".risk-table tbody");
    if (table && result.record) {
      const r = result.record;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${r.date}</td>
        <td>${r.lat}</td>
        <td>${r.lon}</td>
        <td>${r.category}</td>
        <td>${r.is_risky ? "Yes" : "No"}</td>
        <td>${r.risk_score}</td>
        <td>${r.source}</td>
      `;
      table.prepend(row);
    }

    //  Reset form after successful submission
    e.target.reset();

  } catch (err) {
    console.error("Text upload error:", err);
    alert(" Network error while submitting text report.");
  }
});
</script>
{% endblock %}
